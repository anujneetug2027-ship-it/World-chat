<!DOCTYPE html>
<html>
<head>
  <title>Common Chat</title>

  <style>
    body {
      font-family: Arial;
      background: #f2f2f2;
    }
    #login, #chat {
      width: 400px;
      margin: 50px auto;
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
    #messages {
      height: 200px;
      border: 1px solid #ccc;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 5px;
    }
    input {
      width: 75%;
      padding: 5px;
    }
    button {
      padding: 6px 10px;
    }
  </style>
</head>
<body>

<div id="login">
  <h2>Enter Username</h2>
  <input id="username" placeholder="Your name">
  <button onclick="joinChat()">Join</button>
</div>

<div id="chat" style="display:none;">
  <h2>Common Chat Room</h2>
  <div id="messages"></div>
  <input id="msg" placeholder="Type message">
  <button onclick="sendMessage()">Send</button>
</div>
<script src="/socket.io/socket.io.js"></script>

<script>
  const socket = io();
  let currentUser = "";

  function setCookie(name, value, minutes) {
    const d = new Date();
    d.setTime(d.getTime() + (minutes * 60 * 1000));
    document.cookie = name + "=" + value + ";expires=" + d.toUTCString() + ";path=/";
  }

  function getCookie(name) {
    const cname = name + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i].trim();
      if (c.indexOf(cname) === 0) {
        return c.substring(cname.length, c.length);
      }
    }
    return "";
  }

  function joinChat(usernameFromInput = null) {
    const username = usernameFromInput || document.getElementById("username").value;
    if (!username) {
      alert("Enter username");
      return;
    }

    currentUser = username;

    setCookie("username", username, 60);

    socket.emit("join", username);

    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
  }

  function sendMessage() {
    const msgInput = document.getElementById("msg");
    const message = msgInput.value;

    if (message.trim() === "") return;

    socket.emit("sendMessage", message);
    msgInput.value = "";
  }

  // Load old messages
  socket.on("oldMessages", (oldMsgs) => {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = ""; // clear before loading
    oldMsgs.forEach((data) => {
      const div = document.createElement("div");
      div.innerHTML = `<b>${data.user}:</b> ${data.text}`;
      messagesDiv.appendChild(div);
    });
  });

  // Receive new messages
  socket.on("message", (data) => {
    const div = document.createElement("div");
    div.innerHTML = `<b>${data.user}:</b> ${data.text}`;
    document.getElementById("messages").appendChild(div);
  });

  // Auto login on refresh
  window.onload = function () {
    const savedUser = getCookie("username");
    if (savedUser) {
      joinChat(savedUser);
    }
  };
</script>

</body>
  </html>
