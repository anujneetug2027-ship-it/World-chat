<!DOCTYPE html>
<html>
<head>
  <title>Common Chat</title>
  <style>
    body { font-family: Arial; background: #f2f2f2; }
    #login, #chat {
      width: 400px;
      margin: 50px auto;
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
    #messages {
      height: 250px;
      border: 1px solid #ccc;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 5px;
    }
  </style>
</head>
<body>

<div id="login">
  <h2>Enter Username</h2>
  <input id="username" placeholder="Your name">
  <button onclick="manualJoin()">Join</button>
</div>

<div id="chat" style="display:none;">
  <h2>Common Chat</h2>
  <div id="messages"></div>
  <input id="msg" placeholder="Type message">
  <button onclick="sendMessage()">Send</button>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
  const socket = io();
  let joined = false;

  function setCookie(name, value) {
    document.cookie = name + "=" + value + ";path=/";
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function showChat() {
    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";
  }

  function manualJoin() {
    const username = document.getElementById("username").value.trim();
    if (!username) return alert("Enter username");
    setCookie("username", username);
    joinAfterConnect(username);
  }

  function joinAfterConnect(username) {
    if (joined) return;
    socket.emit("join", username);
    joined = true;
    showChat();
  }

  function sendMessage() {
    const input = document.getElementById("msg");
    const msg = input.value.trim();
    if (!msg) return;
    socket.emit("sendMessage", msg);
    input.value = "";
  }

  socket.on("connect", () => {
    const savedUser = getCookie("username");
    if (savedUser) {
      joinAfterConnect(savedUser);
    }
  });

  socket.on("oldMessages", (oldMsgs) => {
    const box = document.getElementById("messages");
    box.innerHTML = "";
    oldMsgs.forEach((m) => {
      const div = document.createElement("div");
      div.innerHTML = `<b>${m.user}:</b> ${m.text}`;
      box.appendChild(div);
    });
  });

  socket.on("message", (data) => {
    const div = document.createElement("div");
    div.innerHTML = `<b>${data.user}:</b> ${data.text}`;
    document.getElementById("messages").appendChild(div);
  });
</script>

</body>
</html>
